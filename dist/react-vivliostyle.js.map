{"version":3,"file":"react-vivliostyle.js","sources":["../src/renderer.tsx","../src/epage.ts"],"sourcesContent":["import styled from \"@emotion/styled\";\nimport {\n  CoreViewer,\n  Navigation,\n  PageViewMode,\n  Payload,\n  ReadyState,\n} from \"@vivliostyle/core\";\nimport React, { useEffect, useRef } from \"react\";\nimport { epageFromPageNumber } from \"./epage\";\n\nexport type MessageType = \"debug\" | \"info\" | \"warn\";\nexport type NavigationPayload = Omit<Payload, \"internal\" | \"href\" | \"content\">;\nexport type HyperlinkPayload = Pick<Payload, \"internal\" | \"href\">;\n\ninterface VolatileState {\n  docTitle: string;\n  epage: number;\n  epageCount: number;\n  metadata: unknown;\n}\n\ntype ChildrenFunction = ({\n  container,\n  reload,\n}: {\n  container: JSX.Element;\n  reload: () => void;\n}) => React.ReactNode;\n\ninterface RendererProps {\n  source: string;\n  cfiURL?: string;\n  page?: number;\n  zoom?: number;\n  renderAllPages?: boolean;\n  autoResize?: boolean;\n  pageViewMode?: PageViewMode;\n  defaultPaperSize?: {\n    width: number;\n    height: number;\n  };\n  pageBorderWidth?: number;\n  fitToScreen?: boolean;\n  fontSize?: number;\n  background?: string;\n  userStyleSheet?: string;\n  authorStyleSheet?: string;\n  style?: React.CSSProperties;\n  navigateToInternalURLs?: boolean;\n  onToCLoad?: (\n    toggleToC: (visible: boolean, autoHide: boolean) => void,\n    toCVisible: boolean | null,\n    toC: () => void\n  ) => void,\n  onSetInstance?: (instance: any) => void;\n  onMessage?: (message: string, type: MessageType) => void;\n  onError?: (error: string) => void;\n  onReadyStateChange?: (state: ReadyState) => void;\n  onLoad?: (state: VolatileState) => void;\n  onNavigation?: (state: VolatileState) => void;\n  onHyperlink?: (payload: HyperlinkPayload) => void;\n  children?: React.ReactNode | ChildrenFunction;\n}\n\nexport const Renderer: React.FC<RendererProps> = ({\n  source,\n  cfiURL,\n  page = 1,\n  zoom = 1,\n  fontSize = 16,\n  background = \"#ececec\",\n  renderAllPages = true,\n  autoResize = true,\n  pageViewMode = PageViewMode.SINGLE_PAGE,\n  defaultPaperSize,\n  pageBorderWidth = 1,\n  fitToScreen = false,\n  userStyleSheet,\n  authorStyleSheet,\n  style,\n  navigateToInternalURLs,\n  onToCLoad,\n  onSetInstance,\n  onMessage,\n  onError,\n  onReadyStateChange,\n  onLoad,\n  onNavigation,\n  onHyperlink,\n  children,\n}) => {\n  const containerRef = useRef<HTMLDivElement | null>(null);\n  const instanceRef = useRef<CoreViewer | null>();\n  const stateRef = useRef<VolatileState | null>();\n\n  function setViewerOptions() {\n    const viewerOptions = {\n      fontSize,\n      pageViewMode,\n      zoom,\n      renderAllPages,\n      autoResize,\n      defaultPaperSize,\n      pageBorderWidth,\n      fitToScreen,\n    };\n    instanceRef.current!.setOptions(viewerOptions);\n  }\n\n  function loadSource() {\n    const instance = instanceRef.current!;\n    const isPublication = source.endsWith(\".json\");\n    const documentOptions = {\n      ...(cfiURL ? {\n        fragment: cfiURL\n      }: null),\n      ...(userStyleSheet\n        ? {\n            userStyleSheet: [\n              {\n                [userStyleSheet.endsWith(\".css\")\n                  ? \"url\"\n                  : \"text\"]: userStyleSheet,\n              },\n            ],\n          }\n        : null),\n      ...(authorStyleSheet\n        ? {\n            authorStyleSheet: [\n              {\n                [authorStyleSheet.endsWith(\".css\")\n                  ? \"url\"\n                  : \"text\"]: authorStyleSheet,\n              },\n            ],\n          }\n        : null),\n    };\n\n    if (isPublication) {\n      instance.loadPublication(source, documentOptions);\n    } else {\n      instance.loadDocument({ url: source }, documentOptions, {\n        fontSize,\n        pageViewMode,\n        zoom: 1,\n        renderAllPages,\n        autoResize,\n        defaultPaperSize,\n        pageBorderWidth,\n        fitToScreen: false,\n      });\n    }\n  }\n\n  function registerEventHandlers() {\n    function handleMessage(payload: Payload, type: MessageType) {\n      onMessage && onMessage(payload.content, type);\n    }\n\n    const handleDebug = (payload: Payload) => handleMessage(payload, \"debug\");\n    const handleInfo = (payload: Payload) => handleMessage(payload, \"info\");\n    const handleWarn = (payload: Payload) => handleMessage(payload, \"warn\");\n\n    function handleError(payload: Payload) {\n      onError && onError(payload.content);\n    }\n\n    function handleReadyStateChange() {\n      const { readyState } = instanceRef.current!;\n      onReadyStateChange && onReadyStateChange(readyState);\n    }\n\n    function handleLoaded() {\n      onLoad && onLoad(stateRef.current!);\n      onSetInstance && onSetInstance(instance);\n      onToCLoad &&\n        onToCLoad(\n          (visible, autoHide) => instance.showTOC(visible, autoHide),\n          instance.isTOCVisible(),\n          () => instance.getTOC()\n        );\n    }\n\n    function handleNavigation(payload: NavigationPayload) {\n      const { cfi, docTitle, epageCount, epage, metadata } = payload;\n      const currentState = {\n        cfi,\n        docTitle,\n        epageCount,\n        epage: epage as number,\n        metadata,\n      };\n      stateRef.current = currentState;\n      onNavigation && onNavigation(currentState);\n    }\n\n    function handleHyperlink(payload: HyperlinkPayload) {\n      onHyperlink && onHyperlink(payload);\n      if (navigateToInternalURLs && payload.href && payload.internal) {\n        instance.navigateToInternalUrl(payload.href);\n      }\n    }\n\n    const instance = instanceRef.current!;\n    instance.addListener(\"debug\", handleDebug);\n    instance.addListener(\"info\", handleInfo);\n    instance.addListener(\"warn\", handleWarn);\n    instance.addListener(\"error\", handleError);\n    instance.addListener(\"readystatechange\", handleReadyStateChange);\n    instance.addListener(\"loaded\", handleLoaded);\n    instance.addListener(\"nav\", handleNavigation);\n    instance.addListener(\"hyperlink\", handleHyperlink);\n\n    return () => {\n      instance.loadDocument({url: ''});\n      onReadyStateChange && onReadyStateChange(ReadyState.LOADING);\n      instance.removeListener(\"debug\", handleDebug);\n      instance.removeListener(\"info\", handleInfo);\n      instance.removeListener(\"warn\", handleWarn);\n      instance.removeListener(\"error\", handleError);\n      instance.removeListener(\"readystatechange\", handleReadyStateChange);\n      instance.removeListener(\"loaded\", handleLoaded);\n      instance.removeListener(\"nav\", handleNavigation);\n      instance.removeListener(\"hyperlink\", handleHyperlink);\n      onSetInstance && onSetInstance(null);\n      if (containerRef.current) {\n        containerRef.current!.innerHTML = \"\";\n      }\n      containerRef.current = null;\n      instanceRef.current = null;\n      stateRef.current = null;\n    };\n  }\n\n  function initInstance() {\n    instanceRef.current = new CoreViewer({\n      viewportElement: containerRef.current!,\n    });\n  }\n\n  // initialize document and event handlers\n  useEffect(() => {\n    initInstance();\n    setViewerOptions();\n\n    const cleanup = registerEventHandlers();\n    return cleanup;\n  }, []);\n\n  useEffect(() => {\n    loadSource();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [source, authorStyleSheet, userStyleSheet]);\n\n  useEffect(() => {\n    setViewerOptions();\n  }, [\n    fontSize,\n    pageViewMode,\n    zoom,\n    renderAllPages,\n    autoResize,\n    defaultPaperSize,\n    pageBorderWidth,\n    fitToScreen,\n  ]);\n\n  // sync location\n  useEffect(() => {\n    const epage = epageFromPageNumber(page);\n    instanceRef.current?.navigateToPage(Navigation.EPAGE, epage);\n  }, [page]);\n\n  const container = (\n    <Container ref={containerRef} style={style} background={background} />\n  );\n\n  if (typeof children === \"function\" && children instanceof Function) {\n    return children({ container, reload: loadSource });\n  }\n\n  return container;\n};\n\nconst Container = styled.div<Pick<RendererProps, \"background\">>`\n  overflow: scroll;\n  background: ${({ background }) => background};\n\n  @media screen {\n    [data-vivliostyle-page-container] {\n      background: ${({ background }) => background};\n      z-index: 0;\n    }\n\n    [data-vivliostyle-viewer-viewport] {\n      display: flex;\n      overflow: auto;\n      position: relative;\n    }\n\n    [data-vivliostyle-outer-zoom-box] {\n      margin: auto;\n      overflow: hidden;\n      flex: none;\n    }\n\n    [data-vivliostyle-viewer-viewport] [data-vivliostyle-spread-container] {\n      display: flex;\n      flex: none;\n      justify-content: center;\n      transform-origin: left top;\n    }\n\n    [data-vivliostyle-viewer-viewport][data-vivliostyle-page-progression=\"ltr\"]\n      [data-vivliostyle-spread-container] {\n      flex-direction: row;\n    }\n\n    [data-vivliostyle-viewer-viewport][data-vivliostyle-page-progression=\"rtl\"]\n      [data-vivliostyle-spread-container] {\n      flex-direction: row-reverse;\n    }\n\n    [data-vivliostyle-viewer-viewport] [data-vivliostyle-page-container] {\n      margin: 0 auto;\n      flex: none;\n      transform-origin: center top;\n    }\n\n    [data-vivliostyle-viewer-viewport][data-vivliostyle-spread-view=\"true\"]\n      [data-vivliostyle-page-container][data-vivliostyle-page-side=\"left\"] {\n      margin-right: 1px;\n      transform-origin: right top;\n    }\n\n    [data-vivliostyle-viewer-viewport][data-vivliostyle-spread-view=\"true\"]\n      [data-vivliostyle-page-container][data-vivliostyle-page-side=\"right\"] {\n      margin-left: 1px;\n      transform-origin: left top;\n    }\n\n    [data-vivliostyle-viewer-viewport][data-vivliostyle-spread-view=\"true\"]\n      [data-vivliostyle-page-container][data-vivliostyle-unpaired-page=\"true\"] {\n      margin-left: auto;\n      margin-right: auto;\n      transform-origin: center top;\n    }\n  }\n\n  /* vivliostyle-viewport */\n  [data-vivliostyle-layout-box] {\n    position: absolute;\n    left: 0;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    overflow: hidden;\n    z-index: -1;\n  }\n\n  [data-vivliostyle-debug] [data-vivliostyle-layout-box] {\n    right: auto;\n    bottom: auto;\n    overflow: visible;\n    z-index: auto;\n  }\n\n  [data-vivliostyle-page-container] {\n    position: relative;\n    overflow: hidden;\n  }\n\n  [data-vivliostyle-bleed-box] {\n    position: absolute;\n    overflow: hidden;\n    max-width: 100%;\n    max-height: 100%;\n    box-sizing: border-box;\n  }\n\n  [data-vivliostyle-page-box] ~ [data-vivliostyle-page-box] {\n    display: none;\n  }\n\n  [data-vivliostyle-toc-box] {\n    position: absolute;\n    left: 3px;\n    top: 3px;\n    overflow: scroll;\n    overflow-x: hidden;\n    background: rgba(248, 248, 248, 0.9);\n    border-radius: 2px;\n    box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);\n  }\n\n  @media print {\n    [data-vivliostyle-toc-box] {\n      display: none;\n    }\n\n    [data-vivliostyle-outer-zoom-box],\n    [data-vivliostyle-spread-container] {\n      width: 100% !important;\n      height: 100% !important;\n    }\n\n    [data-vivliostyle-spread-container],\n    [data-vivliostyle-page-container] {\n      -moz-transform: none !important;\n      -ms-transform: none !important;\n      -webkit-transform: none !important;\n      transform: none !important;\n    }\n\n    [data-vivliostyle-page-container] {\n      display: block !important;\n      max-width: 100%;\n      height: 100% !important;\n      max-height: 100%;\n    }\n\n    /* Workaround for Chrome printing problem */\n    /* [data-vivliostyle-page-box] {\n        padding-bottom: 0 !important;\n        overflow: visible !important;\n    } */\n    [data-vivliostyle-bleed-box] > div > div::before {\n      display: block;\n      content: \"\";\n      padding-top: 0.015625px;\n      margin-bottom: -0.015625px;\n    }\n\n    /* Gecko-only hack, see https://bugzilla.mozilla.org/show_bug.cgi?id=267029#c17 */\n    @-moz-document regexp('.*') {\n      [data-vivliostyle-page-container]:nth-last-of-type(n + 2) {\n        top: -1px;\n        margin-top: 1px;\n        margin-bottom: -1px;\n      }\n    }\n  }\n`;\n","export function epageToPageNumber(epage: number): number {\n  return Math.round(epage + 1);\n}\n\nexport function epageFromPageNumber(pageNumber: number): number {\n  return pageNumber - 1;\n}\n"],"names":["Container","styled","div","background","source","cfiURL","page","zoom","fontSize","renderAllPages","autoResize","pageViewMode","PageViewMode","SINGLE_PAGE","defaultPaperSize","pageBorderWidth","fitToScreen","userStyleSheet","authorStyleSheet","style","navigateToInternalURLs","onToCLoad","onSetInstance","onMessage","onError","onReadyStateChange","onLoad","onNavigation","onHyperlink","children","containerRef","useRef","instanceRef","stateRef","setViewerOptions","current","setOptions","loadSource","instance","isPublication","endsWith","documentOptions","fragment","loadPublication","loadDocument","url","useEffect","CoreViewer","viewportElement","handleMessage","payload","type","content","handleDebug","handleInfo","handleWarn","handleError","handleReadyStateChange","readyState","handleLoaded","visible","autoHide","showTOC","isTOCVisible","getTOC","handleNavigation","currentState","cfi","docTitle","epageCount","epage","metadata","handleHyperlink","href","internal","navigateToInternalUrl","addListener","ReadyState","LOADING","removeListener","innerHTML","registerEventHandlers","navigateToPage","Navigation","EPAGE","container","React","ref","Function","reload"],"mappings":"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"}